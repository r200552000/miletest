<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>TDCç’°å“©åŒ¯ x èˆªç©ºå¡æ¶ˆè²»ç´¯å“©å·¥å…· v10.1</title>

  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Mali:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* =========================
       CSS æ¨£å¼è¡¨ (v10.1 Final)
       ========================= */
    :root {
      --bg-main: #fffdf9;
      --bg-card: #ffffff;
      --primary: #60a5fa;
      --primary-dark: #2563eb;
      --text-header: #334155;
      --text-body: #475569;
      --text-light: #94a3b8;
      --shadow-draw: 3px 3px 0px rgba(0,0,0,0.06);
      --radius-box: 24px;
      --radius-pill: 50px;
      --font-hand: 'Mali', cursive;
      --font-main: 'Varela Round', sans-serif;
    }

    body {
      background-color: var(--bg-main);
      color: var(--text-body);
      font-family: var(--font-main);
      padding-bottom: 120px;
      min-height: 100vh;
      background-image: radial-gradient(#e0f2fe 2px, transparent 2px);
      background-size: 24px 24px;
      -webkit-tap-highlight-color: transparent;
    }

    h1,h2,h3,h4,h5,h6 { font-family: var(--font-hand); font-weight: 700; color: var(--text-header); }

    /* Header */
    .header {
      background: #ffffff; padding: 15px 20px 25px 20px;
      border-bottom-left-radius: 36px; border-bottom-right-radius: 36px;
      position: sticky; top: 0; z-index: 1000;
      box-shadow: var(--shadow-draw); margin-bottom: -10px;
      display: flex; justify-content: space-between; align-items: center;
      height: 100px; border-bottom: 3px dashed #bae6fd;
    }
    .header-icon {
      width: 44px; height: 44px; background: #eff6ff; border: 2px solid #bfdbfe;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: var(--primary); font-size: 1.2rem; transform: rotate(-5deg); margin-right: 12px;
      flex-shrink: 0;
    }
    .header-title h5 { 
      margin: 0; 
      font-size: 1.1rem; 
      color: var(--primary-dark); 
      line-height: 1.3;
    }
    .header-title small { color: var(--text-light); font-size: 0.8rem; font-family: var(--font-hand); }

    .btn-header {
      background: #fff; border: 2px solid #e2e8f0; color: var(--text-body);
      font-weight: 700; font-family: var(--font-hand); font-size: 0.9rem;
      padding: 8px 14px; box-shadow: 2px 2px 0 #e2e8f0; border-radius: 20px;
      transition: 0.1s; white-space: nowrap;
    }
    .btn-header:active { transform: translateY(2px); box-shadow: 0 0 0; }

    .container-custom { padding: 20px 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 101; }
    
    .card-box {
      background: var(--bg-card);
      border-radius: var(--radius-box);
      padding: 20px; margin-bottom: 16px;
      border: 2px solid #f1f5f9;
      box-shadow: var(--shadow-draw);
    }

    .form-label {
      font-weight: 700; color: var(--text-header);
      margin-bottom: 6px; font-size: 0.9rem; font-family: var(--font-hand);
    }
    .form-control, .form-select {
      background-color: #fff !important; border: 2px solid #cbd5e1 !important;
      color: var(--text-header) !important;
      padding: 10px 14px; border-radius: 16px;
      font-size: 1rem; font-weight: 600; height: 48px;
      box-shadow: inset 2px 2px 4px rgba(0,0,0,0.03);
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2) !important;
    }
    
    #amount { color: var(--primary) !important; font-size: 1.5rem; letter-spacing: 1px; font-family: var(--font-hand); transition: 0.3s; }
    
    /* Buttons */
    .btn-action {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      color: white; font-weight: 700; border-radius: var(--radius-pill);
      padding: 14px; width: 100%; border: none; font-size: 1.1rem;
      font-family: var(--font-hand);
      box-shadow: 3px 3px 0 rgba(59, 130, 246, 0.25);
      margin-top: 10px; border: 2px solid #bfdbfe;
      transition: 0.1s;
    }
    .btn-action:active { transform: translateY(3px); box-shadow: 0 0 0; }

    /* Switch Groups */
    .switch-group {
      background: #f8fafc; padding: 10px 14px; border-radius: 16px;
      border: 2px solid #e2e8f0; box-shadow: 2px 2px 0 #e2e8f0;
      display: flex; align-items: center; justify-content: space-between;
      height: 100%; white-space: nowrap; cursor: pointer;
    }
    .switch-label {
      font-size: 0.85rem; font-weight: 700; color: var(--text-body);
      font-family: var(--font-hand); margin-right: 4px; display: flex; align-items: center; gap: 6px;
    }
    .form-check-input {
      width: 2.8em; height: 1.5em;
      background-color: #cbd5e1; border: 2px solid #cbd5e1;
      cursor: pointer; transition: 0.3s; flex-shrink: 0;
    }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }

    /* Result Cards */
    #result-area { display: none; animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes popUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .result-tag {
      background: var(--primary); color: white;
      padding: 4px 16px; border-radius: 20px; font-size: 0.85rem;
      font-weight: 700; display: inline-block; font-family: var(--font-hand);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
      transform: rotate(-1deg);
    }

    .plan-card {
      padding: 16px; border-radius: 18px; margin-top: 12px;
      border: 2px solid #f1f5f9; position: relative; background: #fff;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.03);
    }
    .plan-winner { 
      border-color: var(--primary); background: #f0f9ff; 
      transform: rotate(-0.5deg);
    }
    .winner-badge {
      position: absolute; top: -12px; right: 10px;
      background: #fde047; color: var(--text-header);
      font-size: 0.75rem; padding: 4px 12px; border-radius: 14px;
      font-weight: 700; border: 2px solid #fde047;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
      transform: rotate(3deg); font-family: var(--font-hand);
    }
    .warning-badge {
      background: #fee2e2; color: #ef4444; font-size: 0.75rem;
      padding: 2px 8px; border-radius: 8px; font-weight: 700;
      border: 1px solid #fecaca; display: inline-block; margin-top: 4px;
    }
    .card-name { font-size: 1.1rem; font-weight: 800; color: var(--text-header); margin: 0; }
    .card-miles { font-size: 1.3rem; color: #34d399; font-weight: 900; font-family: var(--font-hand); }
    .card-tpm { font-size: 0.75rem; color: #94a3b8; font-weight: 700; background: #fff; padding: 2px 8px; border-radius: 10px; display: inline-block; border: 1px solid #e2e8f0; }

    /* NCCC Alert Box */
    .nccc-alert {
      background-color: #fffbeb;
      border: 2px dashed #f59e0b;
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: #92400e;
      text-align: left;
    }
    .nccc-btn {
      display: inline-block;
      margin-top: 8px;
      background: #fff;
      border: 1px solid #f59e0b;
      color: #d97706;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.8rem;
      text-decoration: none;
      box-shadow: 2px 2px 0 rgba(245, 158, 11, 0.2);
    }

    /* Warning for Other Currency */
    #other-currency-warning {
        display: none;
        color: #dc2626;
        background: #fef2f2;
        padding: 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 700;
        margin-top: 8px;
        border: 1px dashed #fecaca;
        font-family: var(--font-hand);
    }

    /* Bottom Nav */
    .nav-bottom {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: 280px; background: #ffffff; border: 3px solid #bfdbfe;
      border-radius: 50px; display: flex; justify-content: space-evenly;
      padding: 8px; z-index: 2000; box-shadow: 4px 4px 0 rgba(191, 219, 254, 0.5);
    }
    .nav-item {
      color: var(--text-light); font-size: 0.85rem; font-weight: 700;
      cursor: pointer; padding: 8px 24px; transition: 0.2s;
      display: flex; align-items: center; gap: 6px; font-family: var(--font-hand);
      border-radius: 30px;
    }
    .nav-item.active { background: #eff6ff; color: var(--primary); }

    /* Settings Modal */
    .modal-content { 
      border-radius: 24px; border: 3px solid #bfdbfe; background: #fffdf7; 
    }
    .modal-header { border-bottom: 2px dashed #e2e8f0; padding: 20px; }
    .modal-title { font-weight: 800; color: var(--text-header); font-family: var(--font-hand); }
    
    .setting-section { 
      background: #fff; padding: 16px; border-radius: 18px; margin-bottom: 16px; 
      border: 2px solid #f1f5f9; box-shadow: 2px 2px 0 #f1f5f9;
    }
    .setting-title { 
      font-size: 0.9rem; font-weight: 700; color: var(--text-header); 
      margin-bottom: 12px; font-family: var(--font-hand); display: flex; align-items: center; gap:6px;
    }
    .setting-title::before { content:''; display:inline-block; width:4px; height:16px; background:var(--primary); border-radius:4px; }

    .custom-card-item {
      background: #f8fafc; padding: 12px; border-radius: 14px; margin-bottom: 10px;
      display: flex; justify-content: space-between; align-items: center;
      border: 2px solid #e2e8f0;
    }
    .delete-btn { 
      color: #ef4444; background: #fff; width: 36px; height: 36px; border-radius: 10px; 
      display: flex; align-items: center; justify-content: center; cursor: pointer; 
      border: 2px solid #fecaca; box-shadow: 2px 2px 0 #fecaca;
    }
    
    /* Update Info (Top) */
    .update-info {
        font-family: var(--font-hand);
        color: #1e293b;
        font-size: 0.85rem;
        font-weight: 700;
        margin-bottom: 12px;
        text-align: center;
        background: #f0f9ff;
        display: inline-block;
        padding: 8px 20px;
        border-radius: 50px;
        border: 2px solid #bfdbfe;
        box-shadow: 2px 2px 0 #bfdbfe;
    }

    /* Disclaimer (High Contrast) */
    .disclaimer-text {
      font-size: 0.9rem;
      color: #000000;
      font-weight: 700;
      text-align: justify;
      line-height: 1.6;
      margin-top: 30px;
      padding: 16px;
      background: #fff;
      border: 2px solid #000;
      border-radius: 16px;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
    }
    
  </style>
</head>

<body>
  <div class="header">
    <div class="d-flex align-items-center">
      <div class="header-icon"><i class="fa-solid fa-plane-departure"></i></div>
      <div class="header-title">
        <h5>TDCç’°å“©åŒ¯ x èˆªç©ºå¡<br>æ¶ˆè²»ç´¯å“©å·¥å…· v10.1</h5>
      </div>
    </div>
    <button class="btn-header" onclick="openSettings()"><i class="fa-solid fa-gear me-1"></i> è¨­å®š</button>
  </div>

  <div class="container-custom">
    
    <div class="text-center w-100">
       <div class="update-info">
         <i class="fa-solid fa-circle-info me-1 text-primary"></i> 
         è³‡æ–™åº«æœ€å¾Œæ›´æ–°ï¼š<span class="db-date-display text-primary"></span>
       </div>
    </div>

    <div id="page-calc" class="page-section">
      <div class="card-box">
        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('birthdayMode')" style="background:#fff1f2; border-color:#fecdd3; box-shadow: 2px 2px 0 #fecdd3;">
              <span class="switch-label text-danger"><i class="fa-solid fa-cake-candles"></i> ç”Ÿæ—¥æœˆ</span>
              <input class="form-check-input" type="checkbox" id="birthdayMode">
            </div>
          </div>
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('flyMode')" style="background:#ecfdf5; border-color:#a7f3d0; box-shadow: 2px 2px 0 #a7f3d0;">
              <span class="switch-label text-success"><i class="fa-solid fa-ticket"></i> è¶Šé£›æœ‰å“©</span>
              <input class="form-check-input" type="checkbox" id="flyMode">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-primary"><i class="fa-solid fa-crosshairs me-1"></i> ç´¯ç©ç›®æ¨™ (èˆªç©º/è¨ˆç•«)</label>
          <select id="redemption-target" class="form-select border-primary" style="background-color: #eff6ff !important; border-width: 2px;">
            <option value="AM_BR">ğŸŒ äºè¬ / é•·æ¦® (AM / BR)</option>
            <option value="CI">ğŸŒ¸ ä¸­è¯èˆªç©º (CI)</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">æ¶ˆè²»é‡‘é¡</label>
          <div class="input-group">
            <input type="number" id="amount" class="form-control" placeholder="0" inputmode="decimal">
          </div>
          <div id="other-currency-warning">
             <i class="fa-solid fa-circle-exclamation me-1"></i> âš ï¸ åŒ¯ç‡æœªçŸ¥ï¼Œè«‹ç›´æ¥è¼¸å…¥ç­‰å€¼å°å¹£é‡‘é¡
          </div>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label">å¹£åˆ¥</label>
            <select id="currency" class="form-select" onchange="toggleCurrencyUI()">
              <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
              <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
              <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
              <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
              <option value="KRW">ğŸ‡°ğŸ‡· KRW</option>
              <option value="THB">ğŸ‡¹ğŸ‡­ THB</option>
              <option value="MOP">ğŸ‡²ğŸ‡´ MOP (æ¾³é–€)</option>
              <option value="VND">ğŸ‡»ğŸ‡³ VND (è¶Šå—)</option>
              <option value="IDR">ğŸ‡®ğŸ‡© IDR (å°å°¼)</option>
              <option value="CNY">ğŸ‡¨ğŸ‡³ CNY</option>
              <option value="SGD">ğŸ‡¸ğŸ‡¬ SGD</option>
              <option value="other">ğŸŒ å…¶ä»–</option>
            </select>
            <div class="text-muted text-end mt-1 font-hand" style="font-size:0.7rem; line-height:1.2;">
                åŒ¯ç‡åƒ…ä¾›åƒè€ƒ (2026/2/3)<br>ç²¾æº–è¨ˆç®—è«‹é¸ã€Œå…¶ä»–ã€è¼¸å…¥å°å¹£
            </div>
          </div>
          <div class="col-6">
            <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
            <select id="payment" class="form-select">
              <option value="physical">ğŸ’³ å¯¦é«”å¡</option>
              <option value="online">ğŸŒ ç·šä¸Š/ç¶²è³¼</option>
              <option value="apple_pay">ğŸ Apple Pay</option>
              <option value="line_pay">ğŸŸ© LINE Pay</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">æ¶ˆè²»é¡åˆ¥ / å‚™è¨»</label>
          <select id="category" class="form-select mb-2" onchange="updateKeywordPlaceholder()">
            <option value="general">ğŸ›ï¸ ä¸€èˆ¬æ¶ˆè²»</option>
            <option value="dining">ğŸ½ï¸ é¤å»³/å¤–é€</option>
            <option value="travel">ğŸ¨ æ—…éŠ/è¨‚æˆ¿</option>
            <option value="flight_ci">ğŸŒ¸ è¯èˆªå®˜ç¶²</option>
            <option value="flight_cx">ğŸŒ² åœ‹æ³°å®˜ç¶²</option>
            <option value="flight_other">âœˆï¸ å…¶ä»–èˆªç©º</option>
          </select>
          <input type="text" id="keyword-input" class="form-control" placeholder="è¼¸å…¥åº—å®¶é—œéµå­— (å¦‚: éº¥ç•¶å‹, Agoda, åœè»Š)..." style="font-size:0.9rem;">
        </div>

        <button onclick="calculate()" class="btn-action">é–‹å§‹è¨ˆç®— <i class="fa-solid fa-calculator ms-2"></i></button>
      </div>

      <div id="result-area">
        <div class="nccc-alert">
          <div class="fw-bold mb-1"><i class="fa-solid fa-triangle-exclamation"></i> ç•™æ„å°é¡æ”¯ä»˜ç„¡å›é¥‹</div>
          é€£é–é€Ÿé£Ÿ(éº¥ç•¶å‹/è‚¯å¾·åŸºç­‰)ã€é£²æ–™åº—ã€åœè»Šå ´ã€ä¾¿åˆ©å•†åº—ç­‰é€šè·¯ï¼Œæ¥µé«˜æ©Ÿç‡å±¬æ–¼ã€ŒNCCCå°é¡æ”¯ä»˜ã€ï¼Œé€šå¸¸ç„¡å›é¥‹ã€‚
          <div class="text-center">
            <a href="https://www.nccc.com.tw/wps/wcm/connect/zh/home/BusinessOperations/CardBusiness/MicroPayment" target="_blank" class="nccc-btn">
              <i class="fa-solid fa-magnifying-glass me-1"></i> æŸ¥è©¢ NCCC å®˜æ–¹åå–®
            </a>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
          <span class="result-tag" id="scenario-tag">ä¸€èˆ¬æ¶ˆè²»</span>
          <span class="small fw-bold text-muted bg-white px-2 py-1 rounded border border-dashed" id="fx-info" style="display:none;"></span>
        </div>

        <div id="cards-container">
          </div>

        <div class="card-box mt-3 p-3 text-center" style="background:#f8fafc; border-style:dashed;">
           <button onclick="recordResult()" class="btn btn-outline-dark rounded-pill fw-bold px-4 w-100" style="font-family:var(--font-hand); border-width:2px;">
             <i class="fa-solid fa-check me-2"></i> è¨˜å¸³é€™ç­† (é¦–é¸)
           </button>
        </div>
      </div>
      
      <div class="disclaimer-text">
        <i class="fa-solid fa-triangle-exclamation text-danger me-1"></i> ä½¿ç”¨è€…æ‡‰è‡ªè¡Œç•™æ„æœ¬å·¥å…·æ›´æ–°æ—¥æœŸå¯èƒ½ä¸¦éæœ€æ–°å…¬å‘Šå¾Œçš„å…Œæ›ã€ç´¯ç©æ¯”ä¾‹ï¼Œå„˜ç®¡æˆ‘å€‘è£½ä½œæ­¤ç¶²ç«™åŠä½œå‡ºå‡è¨­æ™‚å·²åŠ›æ±‚å¯©æ…ï¼ŒæƒŸæ´»å‹•éç¨‹ä¸­æ¼”ç®—çµæœæ‡‰åªè¦–ä½œæŒ‡æ¨™ï¼Œè€Œéçµ•å°æº–ç¢ºè¨ˆç®—ã€‚è©³æƒ…è«‹åƒè€ƒéŠ€è¡Œæ‰€æä¾›ä¹‹æ´»å‹•èªªæ˜ã€‚<br><br>
        äºå•†å“ç››è¯é–£è‚¡ä»½æœ‰é™å…¬å¸ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼æ¯é›†åœ˜åŠæ——ä¸‹é—œè¯å­å…¬å¸ã€åˆ†å…¬å¸ï¼‰ã€ç¤¾åœ˜æ³•äººè‡ºç£å“©ç¨‹ç ”ç©¶ç¤¾ã€ã€Œç’°å“©åŒ¯ãƒ»å°Šè²´å¸¸æ—…å®¢ä¿±æ¨‚éƒ¨ã€ã€ã€Œç¤¾åœ˜æ³•äººç’°çƒå¸¸æ—…å®¢å”æœƒã€å‡ç„¡é ˆå°ä»»ä½•äººå°±ç”±æ–¼ä½¿ç”¨æˆ–ä¾è³´æºè‡ªæ­¤æ´»å‹•ç¶²ç«™çš„è³‡æ–™è€Œå¼•è‡´æˆ–èˆ‡æ­¤æœ‰é—œçš„ä»»ä½•æå¤±ã€æå®³æˆ–ä»»ä½•å½¢å¼çš„è²»ç”¨ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼ä»»ä½•ç¶“æ¿Ÿæå¤±æˆ–å…¶ä»–ç›´æ¥ã€é–“æ¥æˆ–ç›¸æ‡‰è€Œç”Ÿçš„æå®³ï¼‰æ‰¿æ“”è²¬ä»»ã€‚
      </div>

    </div>

    <div id="page-status" class="page-section" style="display:none;">
      <div class="card-box">
        <h5 class="mb-3 text-primary"><i class="fa-solid fa-chart-pie me-2"></i>æœ¬æœŸç´¯ç©</h5>
        <div id="status-container"></div>
        <div class="mt-3 d-flex gap-2">
           <button onclick="clearCurrentStats()" class="btn btn-sm btn-outline-danger flex-grow-1 rounded-pill fw-bold" style="border-width:2px; font-family:var(--font-hand);">é‡ç½®æœ¬æœŸ</button>
           <button onclick="exportData()" class="btn btn-sm btn-outline-primary flex-grow-1 rounded-pill fw-bold" style="border-width:2px; font-family:var(--font-hand);">åŒ¯å‡º JSON</button>
        </div>
      </div>
      
      <div class="card-box mt-3" style="background:#fffbeb; border-color:#fde68a;">
        <h5 class="mb-3 text-warning" style="color:#b45309;"><i class="fa-solid fa-shield-halved me-2"></i>ä¸Šé™å°ç®¡å®¶</h5>
        <div id="limits-container"></div>
        <small class="text-muted d-block mt-2 text-center font-hand">ä¸Šé™æœƒæ ¹æ“šè¨­å®šçš„çµå¸³æ—¥è‡ªå‹•é‡ç½®</small>
      </div>
      
       <div class="disclaimer-text">
        <i class="fa-solid fa-triangle-exclamation text-danger me-1"></i> ä½¿ç”¨è€…æ‡‰è‡ªè¡Œç•™æ„æœ¬å·¥å…·æ›´æ–°æ—¥æœŸå¯èƒ½ä¸¦éæœ€æ–°å…¬å‘Šå¾Œçš„å…Œæ›ã€ç´¯ç©æ¯”ä¾‹ï¼Œå„˜ç®¡æˆ‘å€‘è£½ä½œæ­¤ç¶²ç«™åŠä½œå‡ºå‡è¨­æ™‚å·²åŠ›æ±‚å¯©æ…ï¼ŒæƒŸæ´»å‹•éç¨‹ä¸­æ¼”ç®—çµæœæ‡‰åªè¦–ä½œæŒ‡æ¨™ï¼Œè€Œéçµ•å°æº–ç¢ºè¨ˆç®—ã€‚è©³æƒ…è«‹åƒè€ƒéŠ€è¡Œæ‰€æä¾›ä¹‹æ´»å‹•èªªæ˜ã€‚<br><br>
        äºå•†å“ç››è¯é–£è‚¡ä»½æœ‰é™å…¬å¸ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼æ¯é›†åœ˜åŠæ——ä¸‹é—œè¯å­å…¬å¸ã€åˆ†å…¬å¸ï¼‰ã€ç¤¾åœ˜æ³•äººè‡ºç£å“©ç¨‹ç ”ç©¶ç¤¾ã€ã€Œç’°å“©åŒ¯ãƒ»å°Šè²´å¸¸æ—…å®¢ä¿±æ¨‚éƒ¨ã€ã€ã€Œç¤¾åœ˜æ³•äººç’°çƒå¸¸æ—…å®¢å”æœƒã€å‡ç„¡é ˆå°ä»»ä½•äººå°±ç”±æ–¼ä½¿ç”¨æˆ–ä¾è³´æºè‡ªæ­¤æ´»å‹•ç¶²ç«™çš„è³‡æ–™è€Œå¼•è‡´æˆ–èˆ‡æ­¤æœ‰é—œçš„ä»»ä½•æå¤±ã€æå®³æˆ–ä»»ä½•å½¢å¼çš„è²»ç”¨ï¼ˆåŒ…æ‹¬ä½†ä¸é™æ–¼ä»»ä½•ç¶“æ¿Ÿæå¤±æˆ–å…¶ä»–ç›´æ¥ã€é–“æ¥æˆ–ç›¸æ‡‰è€Œç”Ÿçš„æå®³ï¼‰æ‰¿æ“”è²¬ä»»ã€‚
      </div>
    </div>
  </div>

  <div class="nav-bottom">
    <div class="nav-item active" onclick="switchPage('calc')">
      <i class="fa-solid fa-calculator"></i> è¨ˆç®—
    </div>
    <div class="nav-item" onclick="switchPage('status')">
      <i class="fa-solid fa-chart-simple"></i> ç›£æ§
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âš™ï¸ è¨­å®šèˆ‡å¡ç‰‡ç®¡ç†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          
          <div class="setting-section">
            <div class="setting-title">åŠ ç¢¼è³‡æ ¼ç¢ºèª (è‡ªå‹•æ‰£ç¹³)</div>
            <div class="switch-group mb-2">
              <span class="switch-label">åŒ¯è± Live+ è‡ªå‹•æ‰£ç¹³ <small class="text-muted fw-normal">(ç²¾é¸+1%)</small></span>
              <input class="form-check-input" type="checkbox" id="setting-hsbc-autopay" onchange="updateGlobalSetting('hsbc_autopay', this.checked)">
            </div>
          </div>

          <div class="setting-section">
            <div class="setting-title">å…§å»ºç¥å¡ (è¤‡é›œé‚è¼¯)</div>
            <div id="builtin-cards-list">
              </div>
          </div>

          <div class="setting-section">
            <div class="setting-title">è‡ªè¨‚å¡ç‰‡ (ç°¡æ˜“é‚è¼¯)</div>
            <div id="custom-cards-list" class="mb-3"></div>
            
            <div class="bg-white p-3 rounded-3 border border-2 border-primary-subtle" style="border-style:dashed;">
              <label class="small fw-bold text-primary mb-2 font-hand">ï¼‹ æ–°å¢å¡ç‰‡</label>
              <input type="text" id="new-card-name" class="form-control mb-2" placeholder="å¡ç‰‡åç¨± (å¦‚: é•·æ¦®æ¥µè‡´)">
              <div class="row g-2">
                <div class="col-6">
                  <input type="number" id="new-card-dom" class="form-control" placeholder="åœ‹å…§(å…ƒ/å“©)">
                </div>
                <div class="col-6">
                  <input type="number" id="new-card-for" class="form-control" placeholder="åœ‹å¤–(å…ƒ/å“©)">
                </div>
              </div>
              <button onclick="addCustomCard()" class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold font-hand">ç¢ºèªæ–°å¢</button>
            </div>
          </div>

          <div class="setting-section">
            <div class="setting-title">å¸³å–®çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿ)</div>
            <div id="billing-days-list">
              </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* =========================
       å“©ç¨‹æ”»ç•¥ v10.1 (äºæ´²æ—…éŠå¢å¼·ç‰ˆ)
       ========================= */

    const DB_UPDATE_DATE = "2026/02/03"; 

    // æ–°å¢ dbs_aov
    const BUILTIN_DEFS = [
      { id: 'hsbc_live', name: 'åŒ¯è± Live+', default: true, note: 'é¤é£²è³¼ç‰©ç¥å¡' },
      { id: 'dbs_aov',   name: 'æ˜Ÿå±• å‚³èªªå°æ±º',default: true, note: 'LinePay 10%' },
      { id: 'cube',      name: 'åœ‹æ³° CUBE',  default: true, note: 'å°æ¨¹é»è‡ªé¸' },
      { id: 'ctbc_ci',   name: 'ä¸­ä¿¡ è¯èˆªé¼å°Š',default: true, note: 'ç”Ÿæ—¥æœˆ $6/å“©' },
      { id: 'taishin_cx',name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ',default: true, note: 'è¶Šé£›æœ‰å“© $5/å“©' },
      { id: 'hsbc_inf',  name: 'åŒ¯è± æ—…äººç„¡é™',default: true, note: 'åœ‹å¤– $10/å“©' }
    ];

    // æ˜Ÿå±•çµå¸³æ—¥é è¨­ç‚º 4 è™Ÿ
    const DEFAULT_BILLING = { hsbc:6, cube:18, ctbc:15, taishin:20, dbs:4, other:1 };
    
    // æ›´æ–°åŒ¯ç‡è¡¨ (2026/02/03)
    const RATES = { 
        TWD:1, USD:33.5, JPY:0.225, EUR:36, CNY:4.6, KRW:0.025, THB:0.96, SGD:24.5,
        MOP:4.0, VND:0.0013, IDR:0.0021, other:1 
    };
    
    const CUBE_KEYWORDS = {
      'travel': ['travel','agoda','booking','hotels','airbnb','klook','kkday','é›„ç…','å¯æ¨‚','flight','èˆªç©º','æ©Ÿç¥¨','æµ·å¤–','foreign'],
      'dining': ['dining','é¤å»³','åƒé£¯','é¼æ³°è±','å£½å¸','ç«é‹','ç‡’è‚‰','ç‰›æ’','æ˜Ÿå·´å…‹','ubereats','foodpanda'],
      'digital': ['online','momo','pchome','shopee','è¦çš®','coupang','amazon','åšå®¢ä¾†','steam','netflix','spotify','disney','app store','google play'],
      'select': ['carrefour','å…¨è¯','ä¸­æ²¹','å°äº','é«˜éµ','uber']
    };

    const LIVE_KEYWORDS = {
      'dining': [
        'é¤å»³','åƒé£¯','å¤–é€','ubereats','foodpanda','ç‡’è‚‰','ç«é‹','éº»è¾£','å£½å¸','æ—¥å¼','å±…é…’å±‹','é¤é…’é¤¨','é…’å§','å’–å•¡','ç”œé»','ç‰›æ’','éµæ¿ç‡’','æ‹‰éºµ','èŒ¶å…­','å±‹é¦¬','ä¹¾æ¯','buffet',
        'ç‹å“','äº«é´¨','å¤æ…•å°¼','è¥¿å ¤','çŸ³äºŒé‹','é™¶æ¿å±‹','é’èŠ±é©•', 
        'é¥—è³“','é¥—é¥—','é–‹é£¯','ç“¦åŸ','é¼æ³°è±','æµ·åº•æ’ˆ','é‡‘å¤§é‹¤','ç¯‰é–“', 
        'å£½å¸éƒ','è—å£½å¸','çˆ­é®®','å‰å…†','æ˜å£½å¸',
        'é‡‘è‰²ä¸‰éº¥','æ˜¥å¤§ç›´','è²³æ¨“','æ¶“è±†è…','hooters','å‹ç”°', 
        'éº¥ç•¶å‹','æ˜Ÿå·´å…‹','å¿…å‹å®¢','é”ç¾æ¨‚', 
        'å¯Œç‹','æ–‡å…¬é¤¨','æ•™çˆ¶ç‰›æ’','å±±æµ·æ¨“','é¹½ä¹‹è¯','ç‰¡ä¸¹','logy','inita', 
        'ikea','è«å‡¡å½¼','è²´æ—ä¸–å®¶'
      ],
      'shop': [
        'momo','pchome','è¦çš®','shopee','amazon','ebay','éœ²å¤©','friday','gomaji','æ·˜å¯¶',
        'uniqlo','zara','h&m','net','gu','nike','adidas','outlet', 
        'å°åŒ—101','ä¸‰äº•','å¾®é¢¨','sogo','æ¼¢ç¥','è¯æ³°','æ–°å…‰','skm','att', 
        'ç¾éº—è¯','å—ç´¡','çµ±ä¸€æ™‚ä»£','é é›„','äº¬ç«™','citylink','å¤¢æ™‚ä»£','lalaport', 
        'é«˜å³¶å±‹','ä¸­å‹','é ä¼','éº—å¯¶','æ¯”æ¼¾','å¤§æ±Ÿ','å·¨åŸ','é æ±','global mall','ç’°çƒ', 
        'ç¾©å¤§','å°èŒ‚','å®åŒ¯','ç¾©äº«','noke','å¤§é­¯é–£','æ˜æ›œ','bellavita', 
        'å¯¶é›…','ç„¡å°è‰¯å“','muji','å±ˆè‡£æ°','åº·æ˜¯ç¾','æ¾æœ¬æ¸…','å”å‰è¨¶å¾·'
      ],
      'entertainment': [
        'æ–°å…‰å½±åŸ','å¨ç§€','åœ‹è³“','ç§€æ³°', 
        'ç’°çƒå½±åŸ','è¿ªå£«å°¼','å‰åœåŠ›','æ¨‚å¤©ä¸–ç•Œ','legoland','safari', 
        'å…’ç«¥æ–°æ¨‚åœ’','x park','å°äººåœ‹','å…­ç¦æ‘','æµ·æ´‹å…¬åœ’','éº—å¯¶æ¨‚åœ’','åŠæ¹–å±±','ä¹æ—','å°šé †','ç¾©å¤§éŠæ¨‚', 
        'å·§è™','å‹•ç‰©åœ’','æµ·ç”Ÿé¤¨','å¥‡ç¾åšç‰©é¤¨','å°å®å™¹','é‡æŸ³','åŸ”å¿ƒ','é£›ç‰›','é ‘çš®ä¸–ç•Œ','ç¾è¡“é¤¨', 
        'æ—¥æœˆæ½­','å¤ªå¹³å±±','é˜¿é‡Œå±±','å¤§é›ªå±±','å¢¾ä¸','æ£®æ—éŠæ¨‚å€'
      ]
    };

    const CTBC_BOOKING_KEYWORDS = ['agoda','booking','hotels.com','expedia','trip.com','airbnb'];
    
    // Live+ ç™½åå–® (é€Ÿé£Ÿ)
    const NCCC_FAST_FOOD = ['éº¥ç•¶å‹','è‚¯å¾·åŸº','æ¼¢å ¡ç‹','æ‘©æ–¯','é ‚å‘±å‘±','å¿…å‹å®¢','é”ç¾æ¨‚','æ‹¿å¡é‡Œ','subway'];
    
    // çµ•å°é»‘åå–® (é£²æ–™ã€åœè»Šã€ç‰¹å®šåº—å®¶)
    const NCCC_BLACKLIST = ['å…«æ–¹é›²é›†','çˆ­é®®','è·¯æ˜“è','louisa','cama','50åµ','æ¸…å¿ƒ','è¿·å®¢å¤','å¯ä¸å¯','åœè»Š','å˜Ÿå˜Ÿæˆ¿','å°é¡'];

    // å…±åŒé»‘åå–® (çµ•å°ç„¡å›é¥‹)
    const COMMON_BLOCK = ['ç®¡ç†è²»','ç¤¾å€','ç¨…','å­¸è²»','æ°´è²»','é›»è²»','ç“¦æ–¯','ç½°','è¦è²»','å¥ä¿','é›»ä¿¡','ä¸­è¯é›»ä¿¡','é å‚³','å°ç£å¤§','å„²å€¼','é å€Ÿ','åˆ†æœŸ'];

    // å„å¡å®Œæ•´é»‘åå–®
    const CTBC_BLOCK = [...COMMON_BLOCK, 'å…¨è¯','px','å…¨æ”¯ä»˜','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','etoro','wise','revolut', ...NCCC_BLACKLIST];
    
    const HSBC_BLOCK_BASE = [...COMMON_BLOCK, 'å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åˆ¤æ±ºæ›¸','é†«ç™‚','æ›è™Ÿ','å¹´è²»','æ‰‹çºŒè²»','è³­åš', ...NCCC_BLACKLIST];
    
    const TAISHIN_BLOCK = ['åˆ†æœŸ','å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åœ‹æ°‘å¹´é‡‘','etag','ä¸‰å•†ç¾é‚¦', ...NCCC_BLACKLIST];
    
    const CUBE_BLOCK = [...COMMON_BLOCK, 'å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','è¦è²»','è·¯é‚Šåœè»Š','é†«ç™‚','etag','etoro','wise','è³­åš', ...NCCC_BLACKLIST];


    // --- ç‹€æ…‹ç®¡ç† ---
    const DB_KEY = 'MILES_APP_V8_DATA';
    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if(!raw) return initDB();
      const db = JSON.parse(raw);
      if(typeof db.settings.hsbc_autopay === 'undefined') db.settings.hsbc_autopay = true;
      if(typeof db.settings.billingDays.dbs === 'undefined') db.settings.billingDays.dbs = 4;
      return db;
    }
    function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    function initDB() {
      return {
        settings: {
          enabledBuiltins: BUILTIN_DEFS.map(c => c.id),
          billingDays: { ...DEFAULT_BILLING },
          hsbc_autopay: true
        },
        customCards: [], records: {}, limits: {}
      };
    }

    // --- UI äº’å‹•: å¹£åˆ¥åˆ‡æ› ---
    function toggleCurrencyUI() {
       const curr = $('currency').value;
       const amtInput = $('amount');
       const warn = $('other-currency-warning');
       
       if(curr === 'other') {
          amtInput.classList.add('border-danger');
          amtInput.placeholder = 'è«‹è¼¸å…¥æŠ˜ç®—å°å¹£';
          warn.style.display = 'block';
       } else {
          amtInput.classList.remove('border-danger');
          amtInput.placeholder = '0';
          warn.style.display = 'none';
       }
    }

    // --- è¨ˆç®—æ ¸å¿ƒ ---

    function calculate() {
      const db = loadDB();
      const amt = parseFloat($('amount').value);
      if(!amt) return alert('è«‹è¼¸å…¥é‡‘é¡');
      
      const curr = $('currency').value;
      // ä¿®æ­£é‚è¼¯ï¼šåªè¦ä¸æ˜¯ TWDï¼Œå°±æ˜¯æµ·å¤– (å« "other")
      const isForeign = (curr !== 'TWD'); 
      const isEUR = curr === 'EUR'; 
      const rate = RATES[curr] || 1; 
      const twdBase = Math.round(amt * rate);
      const twdSpend = isForeign ? Math.round(twdBase * 1.015) : twdBase;

      const cat = $('category').value;
      const pay = $('payment').value;
      const kw = ($('keyword-input').value || '').toLowerCase();
      const isBirthday = $('birthdayMode').checked;
      const isFlyMode = $('flyMode').checked;
      const target = $('redemption-target').value; 

      let tags = [];
      if(isForeign) tags.push('åœ‹å¤–');
      if(curr === 'other') tags.push('æ‰‹å‹•åŒ¯ç‡');
      if(pay === 'line_pay') tags.push('LinePay');

      let cubePlan = 'unknown';
      let isLiveSelect = false;

      // CUBE Keyword Check
      if(isForeign || cat==='travel' || cat.startsWith('flight')) cubePlan = 'travel';
      else {
        for(let p in CUBE_KEYWORDS) {
          if(CUBE_KEYWORDS[p].some(w => kw.includes(w))) { cubePlan = p; break; }
        }
        if(cubePlan==='unknown' && cat==='dining') cubePlan = 'dining';
      }

      // Live+ Keyword Check
      if(cat==='dining') isLiveSelect = true;
      else {
        if(
          LIVE_KEYWORDS['dining'].some(w => kw.includes(w)) || 
          LIVE_KEYWORDS['shop'].some(w => kw.includes(w)) ||
          LIVE_KEYWORDS['entertainment'].some(w => kw.includes(w))
        ) {
          isLiveSelect = true;
        }
      }
      
      // Live+ ç‰¹åˆ¥åˆ¤å®šï¼šé€Ÿé£Ÿæ˜¯å¦åœ¨ç™½åå–®
      const isLiveFastFood = NCCC_FAST_FOOD.some(w => kw.includes(w));
      if(isLiveFastFood) isLiveSelect = true; // å¼·åˆ¶è¦–ç‚ºç²¾é¸

      // å…¶ä»–å¡ç‰‡æ˜¯å¦è¦æ“‹é€Ÿé£Ÿ (éLive+å¡é‡é€Ÿé£Ÿ = æ“‹)
      const isBlockFastFood = isLiveFastFood; 

      const isCtbcBooking = CTBC_BOOKING_KEYWORDS.some(w => kw.includes(w));

      // è‹¥é¸ other æˆ– å¤–å¹£ï¼Œé¡¯ç¤ºæ›ç®—é‡‘é¡
      $('fx-info').style.display = (curr !== 'TWD') ? 'inline-block' : 'none';
      $('fx-info').innerText = `ç´„ NT$${twdSpend}`;
      $('scenario-tag').innerText = tags.length ? tags.join(' + ') : 'ä¸€èˆ¬æ¶ˆè²»';

      let results = [];

      // 1. åœ‹æ³° CUBE (æ“‹é€Ÿé£Ÿ + é»‘åå–® + æ”¯ä»˜é™åˆ¶)
      if(db.settings.enabledBuiltins.includes('cube')) {
        let miles = 0;
        let note = '';
        
        let isBlocked = CUBE_BLOCK.some(w => kw.includes(w));
        if (isBlockFastFood) isBlocked = true; // CUBE æ“‹é€Ÿé£Ÿ

        if (isBlocked) {
             miles = 0; note = `<span class="text-danger fw-bold">ğŸš« éå›é¥‹/å°é¡æ”¯ä»˜</span>`;
        } else {
            let pRate = 0.003; 
            let planName = 'ä¸€èˆ¬æ¶ˆè²»(0.3%)';
            const isDowngrade = (pay === 'line_pay') || kw.includes('åˆ†æœŸ');
            
            if (isDowngrade) {
                pRate = 0.003;
                planName = 'ä¸€èˆ¬æ¶ˆè²» (æ”¯ä»˜/åˆ†æœŸé™åˆ¶)';
            } else {
                const planMap = { 'travel':'è¶£æ—…è¡Œ', 'dining':'æ¨‚é¥—è³¼', 'digital':'ç©æ•¸ä½', 'select':'é›†ç²¾é¸' };
                if(cubePlan !== 'unknown' && planMap[cubePlan]) {
                  pRate = 0.03;
                  planName = `åˆ‡æ›è‡³ã€${planMap[cubePlan]}ã€‘(3%)`;
                } else if(isForeign) { 
                   pRate = 0.03; planName = `åˆ‡æ›è‡³ã€è¶£æ—…è¡Œã€‘(3%)`;
                }
            }

            const rawPoints = Math.floor(twdBase * pRate);
            let noteSuffix = '';
            if(target === 'CI') {
                miles = Math.floor(rawPoints * (1000 / 720));
                noteSuffix = `720é»â‡„1000å“© (è¯èˆª)`;
            } else {
                miles = Math.floor(rawPoints * (1000 / 360));
                noteSuffix = `360é»â‡„1000å“© (äºè¬)`;
            }
            note = `${planName}<br><span class="text-muted small">${noteSuffix}</span>`;
        }
        results.push({ id:'cube', name:'åœ‹æ³° CUBE', miles: miles, note: note, type:'mile' });
      }

      // 2. åŒ¯è± Live+ (é€Ÿé£Ÿæ”¾è¡Œ + æ­ç›Ÿæ“‹ + é»‘åå–®)
      if(db.settings.enabledBuiltins.includes('hsbc_live')) {
        let miles = 0;
        let note = '';
        
        let isBlocked = false;
        if (isEUR) {
            isBlocked = true; note = `<span class="text-danger fw-bold">ğŸš« æ­ç›Ÿå¯¦é«”ä¸å›é¥‹</span>`;
        } else if (HSBC_BLOCK_BASE.some(w => kw.includes(w))) {
            isBlocked = true; note = `<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>`;
        }
        
        if (isBlocked) {
            miles = 0;
        } else {
            let displayRate = '0.88%';
            let displayType = 'ä¸€èˆ¬';
            let warning = '';
            const hasAutopay = db.settings.hsbc_autopay;
            let totalPoints = twdBase * 0.0088; 
            
            if(isLiveSelect) { 
               displayType = 'ç²¾é¸';
               displayRate = '3.88%';
               let bonus1 = twdBase * 0.03;
               if(bonus1 > 888) { bonus1 = 888; warning = 'âš ï¸ é€šè·¯åŠ ç¢¼å·²é”ä¸Šé™'; }
               totalPoints += bonus1;
               let bonus2Rate = 0;
               if(isForeign) { bonus2Rate = 0.01; displayType = 'åœ‹å¤–ç²¾é¸'; displayRate = '4.88%'; } 
               else if(hasAutopay) { bonus2Rate = 0.01; displayRate = '4.88%'; } 
               if(isForeign && hasAutopay) displayRate = '5.88%'; 
               if(bonus2Rate > 0) {
                 let bonus2 = twdBase * 0.01;
                 if(bonus2 > 200) { bonus2 = 200; warning = warning ? 'âš ï¸ é›™é‡åŠ ç¢¼å·²é”ä¸Šé™' : 'âš ï¸ ä»»å‹™åŠ ç¢¼å·²é”ä¸Šé™'; }
                 totalPoints += bonus2;
               }
            } else {
               if(hasAutopay) { displayRate = '1.88%'; }
            }
            const cashPoints = Math.floor(totalPoints);
            miles = cashPoints * 2; 
            note = `${displayType} ${displayRate} <br><span class="text-muted small">1é»ç¾é‡‘ç©é»â‡„2å“©</span>`;
            if(warning) note = `${displayType} (æ··åˆè²»ç‡)<br><span class="warning-badge">${warning}</span>`;
        }
        results.push({ id:'hsbc_live', name:'åŒ¯è± Live+', miles: miles, note: note, type:'mile' });
      }

      // 3. æ˜Ÿå±• å‚³èªªå°æ±º (LinePay å°ˆç”¨)
      if(db.settings.enabledBuiltins.includes('dbs_aov')) {
        let miles = 0;
        let note = '';
        
        if (pay === 'line_pay') {
            const limit = 11363; // 1000é» / 10%
            let calcBase = twdSpend;
            let warning = '';
            
            if (twdSpend > limit) {
                calcBase = limit;
                warning = 'âš ï¸ è¶…å‡ºç”œèœœé» (11,363å…ƒ)';
            }

            let rawPoints = calcBase * 0.10;
            
            let convStr = '';
            if(target === 'CI') {
                miles = Math.floor(rawPoints * (100 / 90));
                convStr = '90é»â‡„100å“© (è¯èˆª)';
            } else {
                miles = Math.floor(rawPoints * 2);
                convStr = '50é»â‡„100å“© (é•·æ¦®/äºè¬)';
            }

            note = `LinePay 10%<br><span class="text-muted small">${convStr}</span>`;
            if(warning) {
                note = `LinePay 10% (ä¸Šé™å…§)<br><span class="warning-badge">${warning}</span>`;
            }
        } else {
             miles = 0;
             note = `<span class="text-muted">åƒ…é™ LinePay</span>`;
        }
        
        results.push({ id:'dbs_aov', name:'æ˜Ÿå±• å‚³èªªå°æ±º', miles: miles, note: note, type:'mile' });
      }


      // 4. ä¸­ä¿¡ è¯èˆªé¼å°Š
      if(db.settings.enabledBuiltins.includes('ctbc_ci')) {
        let div = 18;
        let note = 'ä¸€èˆ¬ $18/å“©';
        let miles = 0;

        let isBlocked = CTBC_BLOCK.some(w => kw.includes(w));
        if(isBlockFastFood) isBlocked = true;

        if (isBlocked) {
            miles = 0;
            note = `<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>`;
        } else {
            if (cat === 'flight_ci') {
                div = 9; note = 'è¯èˆªå®˜ç¶² $9/å“©';
            } 
            else if (isCtbcBooking) { 
                div = 9; note = 'æŒ‡å®šè¨‚æˆ¿ç¶² $9/å“©';
            }
            else if(isForeign && (pay === 'physical' || pay === 'apple_pay')) {
                 if(isBirthday) {
                     div = 6; note = `ç”Ÿæ—¥æµ·å¤–å¯¦é«” $6/å“©`;
                 } else {
                     div = 9; note = `æµ·å¤–å¯¦é«” $9/å“©`;
                 }
            }
            else if(isForeign && pay === 'online') {
                div = 18; note = 'æµ·å¤–ç¶²è³¼ $18/å“©';
            }
            if(div === 9 || div === 6) {
                note += ` <br><span class="text-danger small" style="font-size:0.7em;">(å«åŠ ç¢¼ä¸Šé™)</span>`;
            }
            miles = Math.floor(twdBase/div);
        }
        results.push({ id:'ctbc_ci', name:'ä¸­ä¿¡ è¯èˆª', miles: miles, note: note, type:'mile' });
      }

      // 5. å°æ–° åœ‹æ³°ä¸–ç•Œ (æ™ºæ…§ç›£æ§ç‰ˆ)
      if(db.settings.enabledBuiltins.includes('taishin_cx')) {
        let miles = 0;
        let note = '';
        let isFlyMore = false; // é è¨­éè¶Šé£›

        let isBlocked = TAISHIN_BLOCK.some(w => kw.includes(w));
        if(isBlockFastFood) isBlocked = true;

        if (isBlocked) {
             miles = 0; 
             note = `<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>`;
        } else {
            let div = isForeign ? 15 : 22; 
            note = `ç´„${div}å…ƒ/å“©`;
            const isMobilePay = (pay === 'apple_pay' || pay === 'line_pay');

            // è¶Šé£›é‚è¼¯åˆ¤å®š (åƒ…é™ $5/å“© é¡åˆ¥)
            if(isFlyMode && !isMobilePay) {
                if(cat === 'flight_cx') { 
                    div = 5; note = `è¶Šé£›(å®˜ç¶²) $5/å“©`; isFlyMore = true; 
                }
                else if(['agoda','booking','klook','kkday','expedia','hotels','æ˜‡æ†æ˜Œ','é‡‡ç›Ÿ'].some(w=>kw.includes(w))) { 
                    div = 5; note = `è¶Šé£›(æŒ‡å®šæ—…éŠ) $5/å“©`; isFlyMore = true; 
                }
                else if(isForeign && pay === 'physical') { 
                    div = 5; note = `è¶Šé£›(æµ·å¤–å¯¦é«”) $5/å“©`; isFlyMore = true; 
                }
            } else if (isFlyMode && isMobilePay) {
                 note += ` <span class="text-danger small">(Payç„¡$5)</span>`;
            }
            miles = Math.floor(twdBase/div);
        }
        // å°‡åˆ¤æ–·çµæœå¯«å…¥ç‰©ä»¶
        results.push({ id:'taishin_cx', name:'å°æ–° åœ‹æ³°', miles: miles, note: note, type:'mile', isFlyMore: isFlyMore });
      }

      // 6. åŒ¯è± æ—…äºº
      if(db.settings.enabledBuiltins.includes('hsbc_inf')) {
        let miles = 0;
        let note = '';
        let isBlocked = HSBC_BLOCK_BASE.some(w => kw.includes(w));
        if(isBlockFastFood) isBlocked = true; 
        if (isBlocked) {
             miles = 0; note = `<span class="text-danger fw-bold">ğŸš« éå›é¥‹é …ç›®</span>`;
        } else {
            let div = isForeign ? 10 : 18;
            if(cat.startsWith('flight')) div = 10;
            note = `ç´„${div}å…ƒ/å“©`;
            miles = Math.floor(twdBase/div);
        }
        results.push({ id:'hsbc_inf', name:'åŒ¯è± æ—…äºº', miles: miles, note: note, type:'mile' });
      }

      // è‡ªè¨‚å¡ç‰‡
      db.customCards.forEach(c => {
        let div = isForeign ? c.forRate : c.domRate;
        if(!div || div <= 0) div = 999;
        results.push({ id: c.id, name: c.name, miles: Math.floor(twdBase / div), note: `è¨­å®š${div}å…ƒ/å“©`, type: 'custom' });
      });

      // æ’åº
      results.forEach(r => { r.tpm = r.miles > 0 ? (twdSpend / r.miles) : 999; });
      results.sort((a,b) => b.miles - a.miles);
      window.currentBest = { ...results[0], twdSpend, twdBase };
      renderResults(results, twdSpend);
    }

    // --- æ¸²æŸ“èˆ‡è¼”åŠ©åŠŸèƒ½ ---

    function renderResults(list, spend) {
      const con = $('cards-container');
      con.innerHTML = '';
      $('result-area').style.display = 'block';
      if(list.length === 0) {
        con.innerHTML = '<div class="text-center p-3 text-muted">æ²’æœ‰å•Ÿç”¨çš„å¡ç‰‡</div>';
        return;
      }
      list.forEach((c, idx) => {
        const isWinner = idx === 0;
        const div = document.createElement('div');
        div.className = `plan-card ${isWinner ? 'plan-winner' : ''}`;
        let badge = isWinner ? `<span class="winner-badge"><i class="fa-solid fa-crown"></i> WINNER</span>` : '';
        div.innerHTML = `
          ${badge}
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="card-name">${c.name}</h4>
              <div class="text-muted small mt-1 font-hand">${c.note}</div>
            </div>
            <div class="text-end">
              <div class="card-miles">${c.miles} <small style="font-size:0.5em; color:#64748b;">å“©</small></div>
              <div class="card-tpm">${c.tpm < 100 ? c.tpm.toFixed(1) : '>100'} å…ƒ/å“©</div>
            </div>
          </div>
        `;
        con.appendChild(div);
      });
    }

    function getBillingCycle(cardPrefix, billingDay) {
      const now = new Date();
      const today = now.getDate();
      const monthOffset = (today > billingDay) ? 1 : 0;
      const d = new Date(now.getFullYear(), now.getMonth() + monthOffset, 1);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    function recordResult() {
      if(!window.currentBest) return;
      const { id, name, miles, twdSpend, twdBase, isFlyMore } = window.currentBest;
      if(!confirm(`ç¢ºå®šè¨˜å¸³ï¼Ÿ\nå¡ç‰‡ï¼š${name}\nç´¯ç©ï¼š${miles} å“©`)) return;

      const db = loadDB();
      const now = new Date();
      const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      
      // 1. ç´€éŒ„åˆ°ã€Œæœ¬æœŸç´¯ç©ã€(è®“ä½¿ç”¨è€…çŸ¥é“é€™ç­†åˆ·äº†å¤šå°‘)
      if(!db.records[monthKey]) db.records[monthKey] = {};
      if(!db.records[monthKey][id]) db.records[monthKey][id] = { miles:0, spend:0, name };
      db.records[monthKey][id].miles += miles;
      db.records[monthKey][id].spend += twdSpend;

      // 2. è™•ç†ã€Œä¸Šé™ç›£æ§ã€(Limits)
      let day = db.settings.billingDays[id.split('_')[0]] || db.settings.billingDays['other'] || 1;
      if(id === 'dbs_aov') day = db.settings.billingDays['dbs'] || 4;

      let addToLimit = true;
      if (id === 'taishin_cx' && !isFlyMore) {
          addToLimit = false; // å°æ–°ä¸€èˆ¬æ¶ˆè²»ä¸è¨ˆå…¥è¶Šé£›é¡åº¦
      }

      if (addToLimit) {
          let limitKey = '';
          
          if (id === 'taishin_cx') {
              // å°æ–°å¹´åº¦ç›£æ§é‚è¼¯ (YYYY-taishin_cx)
              limitKey = `${now.getFullYear()}-taishin_cx`;
          } else {
              // ä¸€èˆ¬æœˆçµç›£æ§é‚è¼¯ (YYYY-MM-id)
              const cycleKey = getBillingCycle(null, day); 
              limitKey = `${cycleKey}-${id}`;
          }

          if(!db.limits[limitKey]) db.limits[limitKey] = { spend:0, points:0, startDay: day };
          db.limits[limitKey].spend += twdBase; 
          db.limits[limitKey].points += miles;
      }

      saveDB(db);
      alert('âœ… å·²è¨˜å¸³ï¼' + (id==='taishin_cx' && !isFlyMore ? '\n(ä¸€èˆ¬æ¶ˆè²»ä¸ä½”è¶Šé£›é¡åº¦)' : ''));
      updateStatusUI();
    }

    function updateStatusUI() {
      const db = loadDB();
      const now = new Date();
      const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const statusCon = $('status-container');
      const monthData = db.records[monthKey] || {};
      let html = '';
      if(Object.keys(monthData).length === 0) {
        html = '<div class="text-center py-3 text-muted">æœ¬æœˆå°šç„¡ç´€éŒ„</div>';
      } else {
        html = '<ul class="list-group list-group-flush">';
        for(let id in monthData) {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0 border-bottom border-dashed">
            <span class="fw-bold text-secondary">${monthData[id].name}</span>
            <span class="fw-bold text-primary" style="font-family:var(--font-hand);">+${monthData[id].miles}</span>
          </li>`;
        }
        html += '</ul>';
      }
      statusCon.innerHTML = html;

      const limitsCon = $('limits-container');
      let limitHtml = '';
      
      const targets = [
        { id: 'hsbc_live', name: 'åŒ¯è± Live+', limit: 29600, type:'spend' },
        { id: 'ctbc_ci',   name: 'ä¸­ä¿¡ è¯èˆª',  limit: 1440000, type:'spend' },
        { id: 'dbs_aov',   name: 'æ˜Ÿå±• å‚³èªªå°æ±º', limit: 11363, type:'spend' },
        { id: 'taishin_cx',name: 'å°æ–° åœ‹æ³°(è¶Šé£›)', limit: 1000000, type:'spend' }
      ];

      targets.forEach(t => {
        let prefix = t.id.split('_')[0];
        if(t.id === 'dbs_aov') prefix = 'dbs';

        let current = 0;
        let cycleDisplay = '';

        if(t.id === 'taishin_cx') {
            // å°æ–°å¹´åº¦é¡¯ç¤º
            const yearKey = `${now.getFullYear()}-taishin_cx`;
            const record = db.limits[yearKey] || { spend:0 };
            current = record.spend;
            cycleDisplay = `å¹´åº¦ç´¯è¨ˆ (${now.getFullYear()})`;
        } else {
            // ä¸€èˆ¬æœˆçµé¡¯ç¤º
            const day = db.settings.billingDays[prefix] || 1;
            const cycleKey = getBillingCycle(null, day);
            const dataKey = `${cycleKey}-${t.id}`;
            const record = db.limits[dataKey] || { spend:0 };
            current = record.spend;
            cycleDisplay = `çµå¸³æ—¥: æ¯æœˆ${day}è™Ÿ (æœ¬æœŸ: ${cycleKey})`;
        }
        
        const percent = Math.min(100, Math.round((current / t.limit) * 100));
        let color = 'bg-success';
        if(percent > 80) color = 'bg-warning';
        if(percent >= 100) color = 'bg-danger';

        let subMsg = '';
        if(t.id === 'ctbc_ci') subMsg = '<div class="text-danger small mt-1" style="font-size:0.7em;">(è‹¥ç‚ºç”Ÿæ—¥æœˆï¼Œä¸Šé™æ¸›åŠç´„ 72 è¬)</div>';
        if(t.id === 'dbs_aov') subMsg = '<div class="text-danger small mt-1" style="font-size:0.7em;">(LinePay 10% ç”œèœœé»)</div>';
        if(t.id === 'taishin_cx') subMsg = '<div class="text-muted small mt-1" style="font-size:0.7em;">(è¶Šé£›æœ‰å“©ä¸Šé™20è¬å“©ï¼Œåªè¨ˆç®—$5/å“©ä¹‹æ¶ˆè²»)<br><span class="text-danger fw-bold">âš ï¸ æœ¬å¹´åº¦ç´¯ç©ï¼Œä¸éš¨å¸³å–®é‡ç½®</span></div>';

        limitHtml += `
          <div class="mb-3">
            <div class="d-flex justify-content-between small mb-1">
              <strong>${t.name}</strong>
              <span>$${current.toLocaleString()} / $${t.limit.toLocaleString()} (${percent}%)</span>
            </div>
            <div class="progress" style="height: 8px; border-radius:4px; background:#e2e8f0;">
              <div class="progress-bar ${color}" style="width: ${percent}%; border-radius:4px;"></div>
            </div>
            ${subMsg}
            <div class="text-end text-muted mt-1" style="font-size:0.7rem; font-family:var(--font-hand);">${cycleDisplay}</div>
          </div>
        `;
      });
      limitsCon.innerHTML = limitHtml || '<div class="text-center small text-muted">ç„¡é ˆç›£æ§çš„å¡ç‰‡</div>';
    }

    function openSettings() { renderSettings(); new bootstrap.Modal($('settingsModal')).show(); }
    function renderSettings() {
      const db = loadDB();
      $('setting-hsbc-autopay').checked = db.settings.hsbc_autopay;
      
      const builtinCon = $('builtin-cards-list');
      builtinCon.innerHTML = '';
      BUILTIN_DEFS.forEach(def => {
        const isOn = db.settings.enabledBuiltins.includes(def.id);
        builtinCon.innerHTML += `
          <div class="switch-group mb-2">
            <span class="switch-label">${def.name} <span class="text-muted small fw-normal ms-2">(${def.note})</span></span>
            <input class="form-check-input" type="checkbox" ${isOn?'checked':''} onchange="toggleBuiltin('${def.id}')">
          </div>
        `;
      });
      const customCon = $('custom-cards-list');
      customCon.innerHTML = '';
      if(db.customCards.length === 0) customCon.innerHTML = '<div class="text-muted small text-center mb-2">å°šç„¡è‡ªè¨‚å¡ç‰‡</div>';
      db.customCards.forEach((c, idx) => {
        customCon.innerHTML += `
          <div class="custom-card-item">
            <div>
              <div class="fw-bold">${c.name}</div>
              <div class="small text-muted font-hand">åœ‹å…§ ${c.domRate} / åœ‹å¤– ${c.forRate}</div>
            </div>
            <div class="delete-btn" onclick="delCustomCard(${idx})"><i class="fa-solid fa-trash"></i></div>
          </div>
        `;
      });
      const billCon = $('billing-days-list');
      billCon.innerHTML = '';
      const banks = { hsbc:'åŒ¯è±', cube:'åœ‹æ³°', ctbc:'ä¸­ä¿¡', taishin:'å°æ–°', dbs:'æ˜Ÿå±•', other:'å…¶ä»–' };
      for(let key in banks) {
        const day = db.settings.billingDays[key] || 1;
        billCon.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-2 bg-white p-2 rounded border" style="border:2px solid #e2e8f0 !important;">
            <span class="fw-bold text-secondary font-hand">${banks[key]}</span>
            <input type="number" class="form-control form-control-sm w-25 text-center" value="${day}" onchange="updateBilling('${key}', this.value)">
          </div>
        `;
      }
    }
    function updateGlobalSetting(key, val) { const db = loadDB(); db.settings[key] = val; saveDB(db); }
    function toggleBuiltin(id) { const db = loadDB(); const idx = db.settings.enabledBuiltins.indexOf(id); if(idx >= 0) db.settings.enabledBuiltins.splice(idx, 1); else db.settings.enabledBuiltins.push(id); saveDB(db); }
    function addCustomCard() { const name = $('new-card-name').value; const dom = parseFloat($('new-card-dom').value); const fore = parseFloat($('new-card-for').value); if(!name || !dom || !fore) return alert('è«‹å¡«å¯«å®Œæ•´'); const db = loadDB(); db.customCards.push({ id: `cust_${Date.now()}`, name, domRate: dom, forRate: fore }); saveDB(db); renderSettings(); $('new-card-name').value = ''; $('new-card-dom').value = ''; $('new-card-for').value = ''; }
    function delCustomCard(idx) { if(!confirm('åˆªé™¤æ­¤å¡ï¼Ÿ')) return; const db = loadDB(); db.customCards.splice(idx, 1); saveDB(db); renderSettings(); }
    function updateBilling(key, val) { const db = loadDB(); db.settings.billingDays[key] = parseInt(val) || 1; saveDB(db); }
    function $(id) { return document.getElementById(id); }
    function toggleSwitch(id) { /* UI */ }
    function switchPage(p) { document.querySelectorAll('.page-section').forEach(e => e.style.display='none'); $(`page-${p}`).style.display='block'; document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); event.currentTarget.classList.add('active'); if(p==='status') updateStatusUI(); window.scrollTo(0,0); }
    function clearCurrentStats() { if(!confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')) return; const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; db.records[monthKey] = {}; saveDB(db); updateStatusUI(); }
    function exportData() { const db = loadDB(); const blob = new Blob([JSON.stringify(db,null,2)], {type : 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'miles_backup_v10_0.json'; a.click(); }
    
    // åˆå§‹åŒ–
    window.onload = function() { 
        updateStatusUI();
        document.querySelectorAll('.db-date-display').forEach(el => el.innerText = DB_UPDATE_DATE);
    };
  </script>
</body>
</html>
